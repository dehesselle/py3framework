# SPDX-License-Identifier: GPL-3.0-or-later
#
# This file is part of https://github.com/dehesselle/py3framework

name: build
on: [push]

jobs:

################################################################################

  python:
    runs-on: macos-10.15
    env:
      WRK_DIR: /Users/Shared/work
      CCACHE_DIR: /Users/Shared/work/ccache
    steps:

    ### prepare ################################################################

    - name: checkout repository
      uses: actions/checkout@v2
      with:
        submodules: true

    - name: create timestamp
      id: time
      uses: nanzm/get-time-action@v1.1
      with:
        format: "YYYY-MM-DD-HH-mm-ss"

    - name: populate CCACHE_DIR
      id: cache
      uses: actions/cache@v2
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-${{ steps.time.outputs.time }}
        restore-keys: ccache-

    # GitHub does not provide the 10.11 SDK (from Xcode 7.3.1). There is no
    # official public download available from Apple and I don't trust 3rd
    # party sources (e.g. "phracker"), so I'm using my own source.
    - name: install MacOSX10.11.sdk (if secret is set)
      env:
        SDK1011_DOWNLOAD_URL: ${{ secrets.SDK1011_DOWNLOAD_URL }}
      if: env.SDK1011_DOWNLOAD_URL != null
      run:  |
            mkdir -p $WRK_DIR
            curl -L ${{ secrets.SDK1011_DOWNLOAD_URL }} | tar -C $WRK_DIR -xJp
            echo "SDKROOT=$WRK_DIR/$(basename ${SDK1011_DOWNLOAD_URL%%.tar.xz*})" >> $GITHUB_ENV

    ### build: Python ##########################################################

    - name: build ccache
      run: ./105-build_ccache.sh

    - name: build libiconv
      run: ./110-build_iconv.sh

    - name: build zlib
      run: ./120-build_zlib.sh

    - name: build OpenSSL
      run: ./130-build_openssl.sh

    - name: build GNU readline
      run: ./140-build_readline.sh

    - name: build GNU gettext
      run: ./150-build_gettext.sh

    - name: build XZ utils (lzma)
      run: ./160-build_lzma.sh

    - name: build Python
      run: ./210-build_python.sh

    - name: build Libxml2
      run: ./220-build_libxml2.sh

    - name: package Python framework
      run: ./310-package_framework.sh

    ### artifact: Python #######################################################

    - name: create Python archive
      run: tar -C $WRK_DIR/Frameworks -c Python.framework | xz -T 0 >$GITHUB_WORKSPACE/Python.framework.tar.xz

    - name: upload Python archive
      uses: actions/upload-artifact@v2
      with:
        name: Python framework
        path: ${{ github.workspace }}/Python.framework.tar.xz

    ### build: lxml ############################################################

    - name: build lxml wheel
      run: ./410-build_lxml_wheel.sh

    ### artifact: lxml #########################################################

    - name: get wheel name
      id: lxml_wheel
      run: echo "::set-output name=file::$(echo $WRK_DIR/lxml-*.whl)"

    - name: upload lxml wheel
      uses: actions/upload-artifact@v2
      with:
        name: lxml wheel
        path: ${{ steps.lxml_wheel.outputs.file }}
